# 武器数值平衡 · 最终模型与验证流程

> 2026-03-02 | 阿喵 & Vin
> 本文档是数值平衡的**唯一真理源**，取代所有旧文档。

---

## 一、数值架构

### 1.1 伤害公式

```
单次伤害 = baseAttack × basePct × getDmgMultiplier(shopLv)
```

| 变量 | 说明 | 来源 |
|------|------|------|
| baseAttack | 玩家基础攻击力（永久升级） | 沙盒中 =1 |
| basePct | 武器基础百分比 | WeaponBalanceConfig.js |
| getDmgMultiplier(lv) | 共享成长曲线 | ShopCurveConfig.dmgMultPerBracket |

### 1.2 共享成长曲线

```
dmgMultPerBracket: [0.12, 0.20, 0.35, 0.36, 0.38]
                    Lv1-5  6-10  11-15 16-20  21+
规则：5倍数级不加伤害（爽点级），其余每级 +bracket值
```

| ShopLv | getDmgMultiplier | 段间比 |
|--------|-----------------|--------|
| 1  | 1.00  | — |
| 5  | 1.36  | — |
| 10 | 2.16  | — |
| 15 | 3.56  | — |
| 20 | 5.00  | Lv10→20 = ×2.31 |
| 25 | 6.52  | — |
| 30 | 8.04  | Lv20→30 = ×1.61 |

**注意**：共享曲线 10→20 只给 ×2.31，20→30 只给 ×1.61。要达到"每10级×3"的目标，爽点必须贡献剩余的倍率。

### 1.3 DPS公式

```
理论DPS = 单次伤害 × effectiveHits / (CD_ms / 1000)

其中：
  CD = 取决于爽点类型：
    - cd型: getSweetSpotValue(weapon, shopLv)，有下限
    - 非cd型: WeaponBalanceConfig.interval（固定）
  effectiveHits = 每次释放的有效命中数（武器机制决定，见下表）
```

### 1.4 Lv1 基准DPS（理论值，baseAttack=1）

> Lv1 = 商店等级1，dmgMult=1.00，各武器初始状态。
> 这是所有后续等级测试的参照基准。

| 武器 | basePct | CD(ms) | effHits | Lv1 DPS | 备注 |
|------|---------|--------|---------|---------|------|
| 冰爆弹 | 12 | 6000 | 6.00 | 12.0 | AOE覆盖6砖（待校准） |
| 闪电链 | 9 | 3800 | 2.57 | 6.1 | 3链×0.85衰减 |
| 穿甲弹 | 32 | 4500 | 4.26 | 30.3 | 1齐射×5层穿透 |
| 轰炸机 | 12 | 12000 | 8.00 | 8.0 | 4弹×2命中 |

**Lv1 DPS差距**：穿甲弹(30.3) : 冰爆弹(12.0) : 轰炸机(8.0) : 闪电链(6.1) = 5:2:1.3:1

⚠️ 注意：这是**纯理论值**（仅基础参数，不含分支加成）。
沙盒实测值（满级分支）会远高于此，因为分支提供的额外炸弹/AOE/链数/穿透等不在理论公式中。
Lv1理论值用于**验证基础机制是否正确**，不用于平衡调参。

### 1.5 全等级理论DPS总览

| 武器 | Lv1 | Lv10 | Lv20 | Lv30 | 1→10 | 10→20 | 20→30 |
|------|-----|------|------|------|------|-------|-------|
| 冰爆弹 | 12.0 | 31.1 | 90.0 | 193.0 | ×2.59 | ×2.89 | ×2.14 |
| 闪电链 | 6.1 | 19.0 | 53.6 | 97.5 | ×3.11 | ×2.83 | ×1.82 |
| 穿甲弹 | 30.3 | 196.4 | 757.6 | 1705.5 | ×6.48 | ×3.86 | ×2.25 |
| 轰炸机 | 8.0 | 23.0 | 80.0 | 257.3 | ×2.88 | ×3.47 | ×3.22 |

**关键发现**：
- 穿甲弹 1→10 ×6.48 严重超标（齐射1→3 是纯乘区 ×3，叠加 dmgMult ×2.16）
- 闪电链 20→30 ×1.82 不达标（链衰减导致高等级增量递减）
- 轰炸机最健康（所有段都在 ×2.88~×3.47）

### 1.6 目标锚点

| 指标 | 目标 | 容忍范围 |
|------|------|---------|
| 每10级DPS倍率 | ×3 | ×2.0 ~ ×4.0 |
| Lv30 最强/最弱比 | <2x | <3x |
| 武器身份感 | 各有特色 | DPS不追求完全相同 |

---

## 二、四把基础武器设定

### 2.1 冰爆弹 (kunai)

**定位**：AOE范围清场，密集砖克星

| 参数 | 值 | 来源 |
|------|-----|------|
| basePct | 12.0 | WeaponBalanceConfig |
| interval | 6000ms（仅初始参考） | WeaponBalanceConfig |
| 爽点 | CD缩短: base=6000, delta=-500/5级 | WeaponShopDefs |
| CD下限 | 3000ms | Kunai.js:372 Math.max |
| AOE半径 | 1.1列宽 ≈ 58px | WeaponBalanceConfig |
| damageType | ice | — |

**爽点CD曲线**：

| ShopLv | CD(ms) | 频率倍率(vs Lv1) |
|--------|--------|------------------|
| 1  | 6000 | ×1.00 |
| 5  | 5500 | ×1.09 |
| 10 | 5000 | ×1.20 |
| 15 | 4500 | ×1.33 |
| 20 | 4000 | ×1.50 |
| 25 | 3500 | ×1.71 |
| 30 | 3000 | ×2.00 |

**effectiveHits**：AOE覆盖约6个砖块（待沙盒校准）

**理论DPS (baseAttack=1)**：

| ShopLv | dmgMult | baseDmg | CD | effHits | DPS | 段间比 |
|--------|---------|---------|-----|---------|-----|--------|
| 10 | 2.16 | 25.9 | 5000 | 6 | 31.1 | — |
| 20 | 5.00 | 60.0 | 4000 | 6 | 90.0 | ×2.89 |
| 30 | 8.04 | 96.5 | 3000 | 6 | 193.0 | ×2.14 |

**⚠️ 问题**：20→30 只有 ×2.14，偏低。因为CD从4000→3000只有×1.33频率提升，共享曲线×1.61×1.33=×2.14。

**待调整方向**：可能需要加大 delta 或调 basePct。

---

### 2.2 闪电链 (lightning)

**定位**：链式传导，分散目标高效

| 参数 | 值 | 来源 |
|------|-----|------|
| basePct | 9.0 | WeaponBalanceConfig |
| interval | 3800ms（固定） | WeaponBalanceConfig |
| 爽点 | 链数: base=3, delta=+1/5级 | WeaponShopDefs |
| 链衰减 | 15%/跳 | chainDecayBase=0.15 |
| damageType | lightning | — |

**爽点链数曲线**：

| ShopLv | 链数 | 有效命中(含衰减) | 命中倍率(vs Lv1) |
|--------|------|-----------------|------------------|
| 1  | 3 | 2.57 | ×1.00 |
| 5  | 4 | 3.19 | ×1.24 |
| 10 | 5 | 3.71 | ×1.44 |
| 15 | 6 | 4.15 | ×1.62 |
| 20 | 7 | 4.53 | ×1.76 |
| 25 | 8 | 4.85 | ×1.89 |
| 30 | 9 | 5.12 | ×1.99 |

**effectiveHits** = Σ(0.85^i, i=0..chains-1)

**理论DPS (baseAttack=1)**：

| ShopLv | dmgMult | baseDmg | CD | effHits | DPS | 段间比 |
|--------|---------|---------|-----|---------|-----|--------|
| 10 | 2.16 | 19.4 | 3800 | 3.71 | 19.0 | — |
| 20 | 5.00 | 45.0 | 3800 | 4.53 | 53.6 | ×2.82 |
| 30 | 8.04 | 72.4 | 3800 | 5.12 | 97.5 | ×1.82 |

**⚠️ 问题**：20→30 只有 ×1.82，不达标（<2.0）。链数衰减导致高等级增量递减（第8链只贡献0.85^7=0.32的伤害）。

**待调整方向**：降低衰减率 或 增大每次delta 或 配合被动倍率。

---

### 2.3 穿甲弹 (missile)

**定位**：纵深穿透，高伤单列清扫

| 参数 | 值 | 来源 |
|------|-----|------|
| basePct | 32 | WeaponBalanceConfig |
| interval | 4500ms（固定） | WeaponBalanceConfig |
| 爽点 | 齐射数: base=1, delta=+1/5级 | WeaponShopDefs |
| basePierce | 8 | WeaponBalanceConfig |
| 穿透衰减 | 8%/穿 | decayRate=0.08 |
| 连射间隔 | 200ms/发 | salvoDelay |
| damageType | physical | — |

**爽点齐射曲线**：

| ShopLv | 齐射数 | 每发有效穿透(衰减后) | 总有效命中 | 命中倍率(vs Lv1) |
|--------|--------|---------------------|-----------|------------------|
| 1  | 1 | 4.26 | 4.26 | ×1.00 |
| 5  | 2 | 4.26 | 8.52 | ×2.00 |
| 10 | 3 | 4.26 | 12.78 | ×3.00 |
| 15 | 4 | 4.26 | 17.05 | ×4.00 |
| 20 | 5 | 4.26 | 21.31 | ×5.00 |
| 25 | 6 | 4.26 | 25.57 | ×6.00 |
| 30 | 7 | 4.26 | 29.83 | ×7.00 |

> 每发有效穿透 = Σ(0.92^j, j=0..min(pierce,5)-1) = 4.26（假设穿5层）

**理论DPS (baseAttack=1)**：

| ShopLv | dmgMult | baseDmg | CD | effHits | DPS | 段间比 |
|--------|---------|---------|-----|---------|-----|--------|
| 10 | 2.16 | 69.1 | 4500 | 12.78 | 196 | — |
| 20 | 5.00 | 160.0 | 4500 | 21.31 | 758 | ×3.86 |
| 30 | 8.04 | 257.3 | 4500 | 29.83 | 1706 | ×2.25 |

**🔴 严重问题**：穿甲弹 Lv30 DPS=1706 vs 冰爆弹=193，差 **8.8倍**。

**根因**：齐射数线性增长(×7)是纯乘区，每发又自带4.26的穿透命中 → 双重乘区。

**待调整方向**：
- A: 降 basePct（最直接）
- B: 增大穿透衰减（decayRate 0.08→0.15）
- C: 齐射收益递减（每多一发伤害-10%之类）
- D: 降低有效穿透层数（实际环境里砖块可能不够穿）

---

### 2.4 轰炸机 (meteor)

**定位**：低频高伤，大范围覆盖事件

| 参数 | 值 | 来源 |
|------|-----|------|
| basePct | 12 | WeaponBalanceConfig |
| interval | 12000ms（仅初始参考） | WeaponBalanceConfig |
| 爽点 | CD缩短: base=12000, delta=-1500/5级 | WeaponShopDefs |
| CD下限 | 3000ms（配置推算，30级刚好=3000） | — |
| baseBombs | 4 | WeaponBalanceConfig |
| damageType | fire | — |

**爽点CD曲线**：

| ShopLv | CD(ms) | 频率倍率(vs Lv1) |
|--------|--------|------------------|
| 1  | 12000 | ×1.00 |
| 5  | 10500 | ×1.14 |
| 10 | 9000  | ×1.33 |
| 15 | 7500  | ×1.60 |
| 20 | 6000  | ×2.00 |
| 25 | 4500  | ×2.67 |
| 30 | 3000  | ×4.00 |

**effectiveHits** = 4弹 × 2命中/弹 = 8（待沙盒校准）

**理论DPS (baseAttack=1)**：

| ShopLv | dmgMult | baseDmg | CD | effHits | DPS | 段间比 |
|--------|---------|---------|-----|---------|-----|--------|
| 10 | 2.16 | 25.9 | 9000 | 8 | 23.0 | — |
| 20 | 5.00 | 60.0 | 6000 | 8 | 80.0 | ×3.48 |
| 30 | 8.04 | 96.5 | 3000 | 8 | 257 | ×3.22 |

**✅ 最健康**：10→20=×3.48, 20→30=×3.22，都在目标范围内。
轰炸机的爽点(×4频率)和共享曲线(×1.61)配合得最好。

---

## 三、问题总结与调整优先级

### 3.1 当前理论DPS对比

| 武器 | Lv1 | Lv10 | Lv20 | Lv30 | 1→10 | 10→20 | 20→30 | 状态 |
|------|-----|------|------|------|------|-------|-------|------|
| 冰爆弹 | 12.0 | 31.1 | 90.0 | 193.0 | ×2.59 | ×2.89 | ×2.14 | ⚠️ 20→30偏低 |
| 闪电链 | 6.1 | 19.0 | 53.6 | 97.5 | ×3.11 | ×2.83 | ×1.82 | ❌ 20→30不达标 |
| 穿甲弹 | 30.3 | 196.4 | 757.6 | 1705.5 | ×6.48 | ×3.86 | ×2.25 | 🔴 1→10爆炸+绝对值过高 |
| 轰炸机 | 8.0 | 23.0 | 80.0 | 257.3 | ×2.88 | ×3.47 | ×3.22 | ✅ 健康 |

### 3.2 Lv30 DPS 差距

```
穿甲弹 1706 >> 轰炸机 257 > 冰爆弹 193 > 闪电链 98
最强/最弱 = 17.5x（目标 <3x）
```

### 3.3 调整优先级

| # | 问题 | 优先级 | 方向 |
|---|------|--------|------|
| 1 | 穿甲弹DPS过高(17.5倍) | P0 | 降basePct + 增衰减 |
| 2 | 闪电链20→30不达标(×1.82) | P1 | 降衰减或增delta |
| 3 | 冰爆弹20→30偏低(×2.14) | P2 | 增大CD delta |
| 4 | 四武器绝对值差距大 | P1 | 统一校准basePct |

**但是！在调整数值之前，必须先通过沙盒验证 effectiveHits 的估算是否准确。**
理论模型中穿甲弹假设穿5层、齐射全命中，实际可能远达不到。

---

## 四、验证流程（单武器）

对每把武器，按以下流程执行：

### Step 1: 机制验证 + Lv1基线（排除bug）

```
目标：确认武器机制正常 + Lv1初始DPS符合设定
方法：5x速度，固定环境，Lv1单次测试
检查项：
  □ 实测DPS是否 ≈ 理论DPS（Lv1）？
  □ 偏差>50% → 有bug，排查
  □ 偏差30~50% → effectiveHits估算需修正
  □ 偏差<30% → 通过，进入Step 2
  
Lv1通过后，后续等级的测试才有意义。
```

### Step 2: 倍速校准（5x vs 20x）

```
目标：确认20x加速不影响DPS
方法：同一武器+同一环境，分别跑 5x 和 20x（Lv20）
检查项：
  □ 5x DPS vs 20x DPS 偏差 < 10%？→ 20x可用于快速迭代
  □ 偏差 10~15%？→ 20x仅参考，调参用5x
  □ 偏差 >15%？→ 20x不可用，排查物理问题
```

### Step 3: 数值基线

```
目标：获得该武器在 Lv10/20/30 的实测DPS
方法：固定环境沙盒，5x速度，60秒测量，跑3次取平均
输出：
  - 实测DPS vs 理论DPS
  - 偏差 < 30% → 模型校准通过
  - 偏差 > 50% → effectiveHits 需修正
```

### Step 4: 数值调整

```
目标：让实测DPS曲线符合目标锚点
方法：
  1. 在 balance-model.js 中调参数，先算理论
  2. 确认理论达标后，改 WeaponBalanceConfig.js
  3. browserify → 重跑沙盒
  4. 每轮只改1个参数
规则：
  - 先调 basePct（最简单、最直接）
  - 再调爽点 delta（影响曲线形状）
  - 最后才动 interval（影响手感，慎重）
```

### Step 5: 定调

```
该武器的最终数值确认后：
  1. 记录到本文档的"最终数值"章节
  2. 提交 git commit
  3. 进入下一把武器
```

---

## 五、执行顺序

```
1. 轰炸机（最健康，用来做基准参照）
2. 冰爆弹（问题中等，CD型爽点）
3. 闪电链（倍率不达标，需调衰减）
4. 穿甲弹（问题最大，留到最后）
```

每把武器走完 Step 1~5 再进入下一把。
全部定调后，再开始多武器联合测试。

---

## 六、沙盒测试脚本规范

### 核心架构：DPSSandbox v5（存活比例控制）

沙盒基于 `src/debug/DPSSandbox.js`，通过控制砖块存活数量来自动调节砖块HP，使武器始终在"打得动但需要多次命中"的状态下输出，从而测量稳态DPS。

#### 调用方式
```javascript
__dpsSandbox({
  weapon: 'meteor',        // 武器名，或 'all'
  duration: 60,            // 测量时长(秒)，默认60
  speed: 5,                // 游戏倍速，默认5
  warmup: 20,              // 预热时长(秒)，不传则自动检测水位稳定
  targetAlive: 60,         // 目标存活砖块数，默认60
})
__stopSandbox()            // 手动停止
__sandboxReport()          // 查看上次报告
```

#### 启动流程
```
1. _initGame(30)          → 以第30章配置初始化
2. _devInvincible = true  → 玩家无敌
3. _sandboxMode = true    → 跳过渲染 + 禁用掉落物
4. _devTimeScale = speed  → 设置倍速
5. MAX_WEAPONS = 99       → 解除武器上限
6. 武器锁定              → 只保留指定武器，阻止新武器加入
7. 满级所有分支           → 非shopGated分支全部点满
8. 接管砖块生成           → _updateBrickSpawn 被替换为空函数
9. 启动AutoBattle         → AI巡航控制飞机移动
10. 铺初始砖块            → ceil(targetAlive/6/2) 行，约一半目标量
```

#### 水位控制器（核心算法）

每 `baseInterval=1000ms`（游戏时间）执行一次：

```
alive = 当前存活砖块数
ratio = alive / targetAlive

if ratio < 0.5:     → 严重不足：生双行 + HP ×1.12（快速补充）
if ratio < 0.8:     → 偏少：生一行 + HP ×1.05
if ratio 0.8~1.1:   → 水位正好：正常生一行（维持）
if ratio 1.1~1.5:   → 偏多：停止生砖（等消化）
if ratio > 1.5:     → 严重过多：停止生砖
```

稳定检测：ratio 连续 5次 在 0.7~1.3 范围内 → 判定水位稳定。

#### 预热期

两种模式：
- **自动预热**（默认）：水位稳定后开始测量（stableCount >= 5）
- **固定预热**：指定 `warmup` 秒数后强制开始

预热结束时清零所有统计（totalDamage, killCount, damageBySource等）。

#### 正式测量

- 每5秒记录一个快照（intervalDps, avgDps, alive, hp）
- hook `combat.damageBrick` 记录所有伤害（按来源分类）
- hook `buffSystem` 记录 burn/chill/freeze/shock/arc 触发次数
- 达到 `duration` 秒后自动停止

#### 输出指标

| 指标 | 说明 |
|------|------|
| 平均DPS | totalDamage / measureSec |
| 稳定DPS | 去掉首尾快照的区间DPS平均 |
| 峰值DPS | 最高区间DPS |
| 击杀砖块 | 测量期间总击杀 |
| 平均存活 | 快照存活数的平均 |
| 稳定砖HP | 最终水位控制器的 currentHP |
| 武器汇总 | 各武器伤害占比（子来源归类到武器） |
| 时间线 | 每5秒快照的DPS/存活/HP变化 |

#### 沙盒环境屏蔽项

| 项目 | 状态 | 方式 |
|------|------|------|
| 玩家死亡 | ❌ 屏蔽 | `_devInvincible = true` |
| 渲染绘制 | ❌ 跳过 | `_sandboxMode → render() return` |
| 掉落物(金币/宝箱) | ❌ 屏蔽 | `_sandboxMode → generateDrops 跳过` |
| 经验球 | ✅ 保留 | 触发升级选技能（AutoBattle自动选） |
| Boss生成 | ❌ 不触发 | `_sandboxMode → _startBoss 跳过` |
| 新武器解锁 | ❌ 屏蔽 | `addWeapon` 被拦截 |
| 原生砖块生成 | ❌ 屏蔽 | `_updateBrickSpawn` 被替换 |
| 三选一弹框 | ⚡ 快速跳过 | `AutoBattle: 高倍速下1帧延迟自动选` |

#### 固定环境测试脚本 (web/fixed-env-test.js)

基于 DPSSandbox 的封装，用于批量测试不同商店等级：

```javascript
runFixedTest({
  weapon: 'meteor',              // 测试武器
  levels: [1, 10, 20, 30],      // 商店等级列表
  speed: 5,                      // 倍速
  repeat: 3,                     // 每等级重复次数
})
// 结果: window.__fixedResults
```

特性：
- 自动设置 `saveManager.weaponLevels[weapon] = shopLv`
- 每组测试调用 DPSSandbox，复用水位控制
- 统计 avgDps / stddev / cv / runs / kills
- 自动计算等级间倍率 (ratio_10to20 等)

#### 倍速校准

| 对比 | 用途 | 判定 |
|------|------|------|
| 5x vs 20x (@Lv20) | 验证高倍速不失真 | 偏差 <10% → 20x可用 |
| 偏差 10~15% | 20x仅参考 | 调参用5x |
| 偏差 >15% | 20x不可用 | 排查碰撞/物理问题 |

#### 已知问题与注意事项

1. **低等级+低HP振荡**：当武器DPS远超砖块HP时（如Lv1轰炸机一波清屏），水位控制器会在"暴涨→暴跌"间振荡，导致CV>50%。高等级（Lv20+）通常稳定（CV<5%）。
2. **脉冲型武器**（轰炸机12秒CD、导弹齐射）比持续型武器更容易触发水位振荡。
3. **effectiveHits 理论值不可靠**：武器满级分支后实际命中数远超基础值，必须用沙盒实测。
4. **GravityWell ctx bug**（已修复 v4.2+）：`_spawnNegaBrick` 缺少 ctx 参数。

## 七、最终数值记录

> 每把武器定调后填入此处。当前为空（尚未开始验证流程）。

### 轰炸机 (meteor)
```
状态: 待验证
basePct: 12
interval: 12000ms (base)
sweetSpot: cd, base=12000, delta=-1500
effectiveHits: 8 (待校准)
```

### 冰爆弹 (kunai)
```
状态: 待验证
basePct: 12.0
interval: 6000ms (base)
sweetSpot: cd, base=6000, delta=-500
effectiveHits: 6 (待校准)
```

### 闪电链 (lightning)
```
状态: 待验证
basePct: 9.0
interval: 3800ms (固定)
sweetSpot: chains, base=3, delta=+1
effectiveHits: 动态(链数相关)
```

### 穿甲弹 (missile)
```
状态: 待验证
basePct: 32
interval: 4500ms (固定)
sweetSpot: salvo, base=1, delta=+1
effectiveHits: 动态(齐射数×穿透)
```

---

## 八、旧文档处置

| 文档 | 状态 |
|------|------|
| BALANCE_MODEL.md | 归档，参数已过时 |
| BALANCE_METHODOLOGY.md | 保留，方法论仍有效 |
| BALANCE_FRAMEWORK.md | 归档，被本文档取代 |
| WEAPON_BALANCE_GUIDE.md | 归档，R8数据用旧沙盒 |
| BALANCE_PIPELINE.md | 保留，流程参考 |
| WEAPON_DESIGN.md | 保留，机制设计参考 |
| WEAPON_LEVEL_DESIGN.md | 保留，等级节奏参考 |
| **BALANCE_FINAL.md** | **当前真理源** |

---

*"先量准尺子，再量布料。"* 🐾
