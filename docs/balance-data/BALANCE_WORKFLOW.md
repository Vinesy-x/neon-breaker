# 武器平衡标准流程

> 每把武器按此流程执行，完成后在 `docs/balance-data/<weapon>-balance.md` 记录全过程。

---

## Phase 0: 信息收集

### 0.1 收集武器参数
从代码/配置中确认：
- [ ] basePct, interval（WeaponBalanceConfig）
- [ ] 爽点类型及参数（WeaponShopDefs: base, delta, floor）
- [ ] 基础伤害公式（武器.js 中的 getDamage → effHits 怎么算）
- [ ] 特殊机制（AOE系数、穿透衰减、链数等）

### 0.2 收集分支信息
- [ ] 基础分支（shopLv=1 可用）及各分支 max 点数
- [ ] shopGated 分支解锁节点（跑 `WSD.getUnlockedBranches(weapon, lv)`）
- [ ] 各 shopLv 对应的累计可用点数

### 0.3 收集被动信息
- [ ] 被动解锁节点（跑 `WSD.getUnlockedPassives(weapon, lv)`）
- [ ] 每个被动的具体效果（grep 武器.js 中的 hasWeaponPassive）
- [ ] 各 shopLv 对应的累计被动数

---

## Phase 1: basePct 标定

### 目标
无分支 Lv1 DPS = **1.0**

### 步骤
1. **估算 effHits**：根据武器机制估算无分支时一次攻击的等效命中数
   - 纯单体武器: effHits ≈ 1
   - AOE武器: effHits = 1(直击) + N(溅射命中数) × 溅射系数
   - 穿透武器: effHits = 穿透次数 × 衰减系数加权
   - 链式武器: effHits = 链数(无分支) × 衰减加权

2. **初算 basePct**：
   ```
   basePct = 目标DPS × (interval_ms / 1000) / effHits
           = 1.0 × interval_sec / effHits
   ```

3. **沙盒验证**：跑 `fullBranch=false, shopLv=1, @10x, 120s`
   - 实测DPS 应接近 1.0
   - 如果偏差 >20%，说明 effHits 估算不准，用实测反推：
     ```
     实际effHits = basePct × 1000 / interval / 实测DPS
     新basePct = 旧basePct × (1.0 / 实测DPS)
     ```
   
4. **迭代直到无分支DPS = 1.0 ± 10%**

---

## Phase 2: 模型预测

### 公式
```
预测DPS = 1.0 × 1.25^(可用点数) × 局外成长(含被动)

局外成长 = 共享曲线(shopLv) × 爽点(shopLv) × 1.15^(被动数)
```

### 计算表
填入武器实际的分支点数和被动数：

| ShopLv | 可用点数 | 分支乘数(1.25^pts) | 被动数 | 局外(含被动) | 预测DPS |
|--------|---------|-------------------|--------|-------------|---------|
| 1 | ? | ? | ? | ? | ? |
| 10 | ? | ? | ? | ? | ? |
| 20 | ? | ? | ? | ? | ? |
| 30 | ? | ? | ? | ? | ? |

### 局外成长速查
共享曲线: Lv1=1.00, Lv10=2.16, Lv20=5.00, Lv30=8.04
爽点需按武器类型单独算（CD缩短/链数增加/齐射增加）

---

## Phase 3: 沙盒实测

### 测试条件（标准化）
```
纯武器（禁飞机）, fullBranch=true
@10x, 120s, targetAlive=60
shopLv: 1, 10, 20, 30 各跑一轮
```

### 记录内容
1. **DPS 数据**：avgDps, stableDps
2. **伤害来源分布**：各 damageSource 的绝对值和占比
3. **环境数据**：stableHp, kills, warmupSec

---

## Phase 4: 偏差分析

### 4.1 整体偏差
对比模型预测 vs 实测，计算各等级误差：

| ShopLv | 模型 | 实测 | 误差 | 判定 |
|--------|------|------|------|------|
| 1 | ? | ? | ? | ±25%内=✅, 超出=❌ |
| 10 | ? | ? | ? | |
| 20 | ? | ? | ? | |
| 30 | ? | ? | ? | |

**误差容忍标准**：
- ±25% 以内：✅ 正常（分支实战效率折扣）
- ±25%~50%：⚠️ 需排查原因
- 超过 ±50%：❌ 必须定位并修复

### 4.2 定位超标来源

如果某等级段偏差过大：

1. **查每10级倍率**：实测Lv(n+10)/Lv(n) vs 目标×3
2. **查各伤害来源的段间倍率**：哪个来源的倍率远超×3？
3. **查该段新增内容**：
   - 新解锁的分支（shopGated）？→ 该分支单点收益过高
   - 新解锁的被动？→ 被动效果超过 ×1.15 设计值
   - 都没有？→ 某个分支在高等级的非线性收益膨胀

### 4.3 修改原则

**一次只改一个参数，改完重跑验证。**

修改优先级（从上到下）：
1. **basePct** — 如果无分支锚点不对
2. **单个过强被动** — 如果被动实际效果远超 ×1.15
3. **单个过强分支** — 如果某分支单点收益过高（如 giant）
4. **机制系数**（溅射系数、衰减率等）— 最后手段

**禁止**：
- ❌ 一次改多个参数（无法定位效果）
- ❌ 改通用参数（aoeRadiusScale 等）来修单个武器问题
- ❌ 跳过验证直接进下一步

---

## Phase 5: 定稿

### 确认清单
- [ ] 无分支 Lv1 DPS = 1.0 ± 10%
- [ ] 四级(1/10/20/30)误差均在 ±25% 以内
- [ ] 没有单个伤害来源的段间倍率超过 ×6
- [ ] 更新 WeaponBalanceConfig.js 中的 basePct
- [ ] 更新武器.js 中改动的参数（如 giant 倍率）
- [ ] 更新 `docs/balance-data/<weapon>-balance.md` 完整记录
- [ ] git commit & push

---

## 文档模板

每把武器的 `<weapon>-balance.md` 应包含：

```
# <武器名> (<key>) 平衡记录

## 一、模型预测
  - 设计参数表
  - 分支解锁节点
  - 被动解锁节点
  - 预测DPS表

## 二、调参历程
  - 每个 Step 记录：问题 → 诊断 → 修改 → 结果

## 三、最终实测数据
  - 标准条件下的 DPS + 伤害分布

## 四、当前状态
  - 确认清单打勾
  - 最终配置值
```

---

*创建: 2026-03-02 阿喵*
