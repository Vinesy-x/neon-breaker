# 闪电链 (Lightning) 平衡记录

## 一、模型预测

### 设计参数
| 参数 | 值 | 来源 |
|------|-----|------|
| 无分支Lv1 基础DPS | **1.0** | 设计锚点 |
| 统一n值 | **1.25** | 设计值 |
| 被动乘区 | **×1.15/个** | 设计值 |
| basePct | **0.83** | Lv1满分支标定 |
| interval | 3800ms | WeaponBalanceConfig |
| baseChains | 3 | WeaponBalanceConfig |
| chainsPerLv(爽点) | +1链/5级 | WeaponShopDefs |
| 分支chains | +2链/点 | Lightning.js |
| 链衰减 | **无** | 每跳等伤，charge使递增 |
| 伤害精度 | 保留1位小数 | Math.round(x*10)/10 |

### 分支解锁节点
| ShopLv | 新增分支 | 累计点数 |
|--------|---------|---------|
| 1 | damage(10)+chains(4)+charge(2)+shock(2)+echo(2) | 20 |
| 5 | +paralyze(2) | 22 |
| 10 | +storm(2) | 24 |
| 18 | +overload(1) | **25(全满)** |

### 被动解锁节点
| ShopLv | 被动 | 效果 | 累计被动数 |
|--------|------|------|-----------|
| 6 | shockMark | 被击砖+15%伤3秒 | 1 |
| 14 | residualField | 链尾电场DOT(15%伤×2s) | 2 |
| 22 | chainNoDecay | **每跳伤害+5%递增** | 3 |
| 26 | dualChain | 第2道闪电(**50%伤害**) | 4 |
| 30 | thorGod | 60秒全屏闪电1次 | 5 |

### 预测DPS
```
预测DPS = 1.0 × 1.25^(可用点数) × 局外成长(含被动)
局外 = 共享曲线 × 爽点 × 1.15^(被动数)
```

| ShopLv | 点数 | 分支乘数 | 被动数 | 局外(含被动) | 预测DPS |
|--------|------|---------|--------|-------------|---------|
| 1 | 20 | ×86.7 | 0 | ×1.0 | **87** |
| 10 | 24 | ×211.8 | 1 | ×3.5 | **733** |
| 20 | 25 | ×264.7 | 2 | ×11.9 | **3,118** |
| 30 | 25 | ×264.7 | 5 | ×54.3 | **14,228** |

---

## 二、调参历程

### Step 1: Math.floor → 保留1位小数

**问题**：basePct<2 时 Math.floor 将小数截断为0/1，低等级DPS不随basePct线性变化。

**修改**：`Math.floor(x)` → `Math.round(x*10)/10`，影响2处：
- Lightning.js:105 — 链伤害计算
- Lightning.js:172 — 电场DOT伤害

### Step 2: basePct 标定

| basePct | Lv1满分支DPS | vs模型87 | 说明 |
|---------|-------------|---------|------|
| 0.91(Math.floor) | 85.9 | -1.3% | floor下标定 |
| 1.28(Math.round) | 134 | +54% ❌ | round后偏高 |
| **0.83** | **72.2** | **-17%** ✅ | 最终值 |

### Step 3: chainNoDecay 被动重设计

**问题**：闪电链本无链衰减，chainNoDecay 被动是空操作。

**方案历程**：
1. ❌ 加10%/跳衰减 + 被动移除：衰减使 Lv1~20 DPS降50%，被动移除=×2.0+超红线
2. ✅ **不加衰减，被动改为每跳+5%伤害递增**：温和增益，高链数才有感

效果：11链时理论×1.32，实测×1.42。

### Step 4: dualChain 被动削弱

**问题**：第2道闪电=完整伤害，等于被动×2.0，远超×1.15红线。实测×1.6。

**修改**：第2道闪电伤害×0.5（getDamage 乘以 `_dualDmgMult`）。

| 状态 | Lv30 DPS | vs模型14,228 |
|------|---------|------------|
| dualChain 全额(×1.0) | 16,844 | +18% |
| **dualChain 半伤(×0.5)** | **14,560** | **+2.3%** ✅ |

削弱幅度：-13.6%，误差从+18%降到+2.3%。

---

## 三、最终实测数据

**测试条件**：纯武器(禁飞机), @10x, 120s, targetAlive=60, fullBranch=true

| ShopLv | 实测DPS | 模型预测 | 误差 | 段间倍率 |
|--------|---------|---------|------|---------|
| 1 | 72.2 | 87 | **-17%** ✅ | — |
| 10 | 809 | 733 | **+10%** ✅ | ×11.2 |
| 20 | 2,731 | 3,118 | **-12%** ✅ | ×3.4 |
| 30 | 14,560 | 14,228 | **+2.3%** ✅ | ×5.3 |

> Lv1/10/20 数据来自 dualChain 削弱前（Lv1~20 无 dualChain 被动，不受影响）
> Lv20→30=×5.3 偏高，主因 dualChain(×1.3)+chainNoDecay(×1.42) 叠加

**伤害来源分布(Lv30)：**
| 来源 | 占比 |
|------|------|
| lightning(主链) | 74.9% |
| lightning_aoe(storm) | 15.1% |
| shock_arc | 8.1% |
| electric_field(被动) | 1.6% |
| lightning_thor(被动) | 0.3% |

---

## 四、当前状态

✅ **basePct=0.83** — Lv1误差-17%, Lv30误差+2.3%
✅ **Math.floor→Math.round(x*10)/10** — 低数值精度修复
✅ **chainNoDecay: 每跳+5%** — 从空被动变有效被动(×1.42)
✅ **dualChain: 半伤(×0.5)** — 从×1.6降到约×1.3

### 已知问题（记录备查）
- **thorGod(Lv30)贡献极低(0.3%)**：60秒1次全屏，几乎纯视觉。后续可考虑加强
- **Lv20→30=×5.3 偏高**：chainNoDecay+dualChain 两个强被动叠加，但绝对误差仅+2.3%

### 最终配置值
```
basePct: 0.83
interval: 3800
baseChains: 3
chainsPerLv: +1/5级
链衰减: 无
chainNoDecay: 每跳+5%伤害
dualChain: 第2道闪电×0.5伤害
伤害精度: Math.round(x*10)/10
```

---

*初始记录: 2026-03-02*
*最终更新: 2026-03-02 — dualChain×0.5削弱, chainNoDecay每跳+5%, Lv30误差+2.3%*
